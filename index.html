<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RudderStack Event Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html.dark { color-scheme: dark; }
        body { font-family: 'Inter', sans-serif; }
        .card { transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .dark .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(9, 9, 11, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: #18181b; border: 1px solid #27272a;
            padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 95%; width: 600px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            background-color: #09090b;
            color: #fafafa;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -10px);
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .hidden { display: none; }
        .nav-link.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }
        #generatedCode {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Dracula Theme for Code Blocks */
        pre {
            background-color: #282a36; /* Dracula Background */
            color: #f8f8f2;           /* Dracula Foreground */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        pre code {
            font-family: inherit;
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
    </style>
</head>
<body class="bg-zinc-900 text-gray-200">

    <header class="bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800 sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="layout-template" class="text-orange-500"></i>
                    <span class="font-bold text-xl">Event Tracker</span>
                </div>
                <div class="flex items-center gap-2 bg-zinc-800 px-3 py-1 rounded-full">
                     <span class="text-xs font-mono text-zinc-400">Sheet ID:</span>
                     <span id="appIdDisplay" class="text-xs font-mono text-orange-400">Carregando...</span>
                </div>
            </div>
            <div id="nav-links" class="flex items-center gap-6">
                <a href="#kanban" id="kanbanViewBtn" class="nav-link active text-gray-400 hover:text-orange-500 font-semibold border-b-2 border-transparent transition-colors">Kanban</a>
                <a href="#map" id="mapViewBtn" class="nav-link text-gray-400 hover:text-orange-500 font-semibold border-b-2 border-transparent transition-colors">Mapa de Eventos</a>
                <a href="#snippet-generator" id="snippetGeneratorViewBtn" class="nav-link text-gray-400 hover:text-orange-500 font-semibold border-b-2 border-transparent transition-colors">Gerador de Snippet</a>
                <a href="#readme" id="readmeViewBtn" class="nav-link text-gray-400 hover:text-orange-500 font-semibold border-b-2 border-transparent transition-colors">Como Usar</a>
            </div>
        </nav>
    </header>

    <!-- Main App Container -->
    <main id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        
        <!-- Controls Toolbar -->
        <div id="controls-toolbar" class="mb-8 p-6 bg-zinc-900 border border-zinc-800 rounded-xl shadow-sm space-y-6">
            <!-- Search and Filter Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="lg:col-span-2">
                    <label for="searchInput" class="block text-sm font-medium text-gray-300 mb-1">Buscar Evento</label>
                    <div class="relative"><input type="text" id="searchInput" placeholder="Buscar por nome..." class="w-full pl-10 pr-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800 text-gray-200"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i></div>
                </div>
                <div>
                     <label for="filterOwner" class="block text-sm font-medium text-gray-300 mb-1">Responsável</label>
                     <select id="filterOwner" class="form-select w-full px-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800 text-gray-200"></select>
                </div>
                <div>
                     <label for="filterSection" class="block text-sm font-medium text-gray-300 mb-1">Seção</label>
                     <select id="filterSection" class="form-select w-full px-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800 text-gray-200"></select>
                </div>
            </div>
             <button id="openAddModalBtn" class="w-full bg-orange-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors duration-200 flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i>Adicionar Novo Evento</button>
        </div>

        <!-- Views Container -->
        <div id="views-container">
            <!-- Kanban View -->
            <div id="kanban-view" class="view">
                <!-- Progress and Sort -->
                <div id="kanban-controls" class="mb-8 max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="w-full sm:w-2/3">
                        <div class="flex justify-between mb-1"><span class="text-base font-medium text-orange-400">Progresso</span><span id="progressLabel" class="text-sm font-medium text-orange-400">Calculando...</span></div>
                        <div class="w-full bg-zinc-700 rounded-full h-4"><div id="progressBar" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                    <div class="w-full sm:w-auto">
                        <label for="sortSelect" class="sr-only">Ordenar</label>
                        <select id="sortSelect" class="form-select w-full px-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800 text-gray-200">
                            <option value="createdAt">Ordenar por Data</option>
                            <option value="priority">Ordenar por Prioridade</option>
                        </select>
                    </div>
                </div>

                <!-- Event Lists -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-red-500 flex items-center justify-center gap-2"><i data-lucide="list" class="inline-block"></i>A Fazer</h2>
                        <div id="todo-list" data-status="todo" class="column bg-zinc-900/50 p-4 rounded-xl shadow-inner min-h-[300px] space-y-4"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-yellow-500 flex items-center justify-center gap-2"><i data-lucide="loader-2" class="inline-block"></i>Em Progresso</h2>
                        <div id="inprogress-list" data-status="inprogress" class="column bg-zinc-900/50 p-4 rounded-xl shadow-inner min-h-[300px] space-y-4"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-green-500 flex items-center justify-center gap-2"><i data-lucide="check-circle-2" class="inline-block"></i>Feito</h2>
                        <div id="done-list" data-status="done" class="column bg-zinc-900/50 p-4 rounded-xl shadow-inner min-h-[300px] space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Event Map View -->
            <!-- FIX: Changed ID from event-map-view to map-view to match navigation logic -->
            <div id="map-view" class="view hidden bg-zinc-900 border border-zinc-800 p-6 rounded-xl shadow-sm space-y-6">
                <!-- Content will be generated by JS -->
            </div>

            <!-- Snippet Generator View -->
            <div id="snippet-generator-view" class="view hidden">
                <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-xl shadow-sm max-w-6xl mx-auto space-y-6">
                    <h2 class="text-3xl font-bold text-orange-500">Gerador de Snippet de Tracking</h2>
                    <p class="text-gray-400">Crie um snippet de código funcional para capturar dados de atributos `data-*` de um elemento HTML.</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left Column: Inputs -->
                        <div class="space-y-4">
                            <div class="flex items-end gap-4">
                                <div class="flex-grow">
                                    <label for="snippetEventName" class="block text-sm font-medium text-gray-300 mb-1">Nome do Evento</label>
                                    <input type="text" id="snippetEventName" placeholder="Ex: Product Viewed" class="w-full px-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800">
                                </div>
                                <button id="importFromCardBtn" class="bg-zinc-700 text-white font-semibold px-4 py-2 rounded-lg hover:bg-zinc-600 transition-colors flex items-center gap-2" title="Importar dados de um código de card do Kanban">
                                    <i data-lucide="import" class="w-5 h-5"></i> Importar do Card
                                </button>
                            </div>
                            <div>
                                <label for="snippetElementId" class="block text-sm font-medium text-gray-300 mb-1">ID do Elemento HTML</label>
                                <input type="text" id="snippetElementId" placeholder="Ex: pdp-tracking-data" class="w-full px-4 py-2 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-zinc-800">
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Propriedades</h3>
                                <div id="snippet-properties-list" class="space-y-3">
                                    <!-- Property rows will be added here -->
                                </div>
                                <button id="addSnippetPropertyBtn" class="mt-3 text-sm text-orange-500 font-semibold hover:text-orange-600 flex items-center gap-1">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>Adicionar Propriedade
                                </button>
                            </div>
                             <button id="generateSnippetBtn" class="w-full bg-orange-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors duration-200 flex items-center justify-center gap-2">
                                <i data-lucide="wand-2" class="w-5 h-5"></i>Gerar Snippet
                            </button>
                        </div>

                        <!-- Right Column: Code Output -->
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Snippet Gerado</h3>
                            <div class="relative h-[500px]">
                                <pre class="h-full"><code id="generatedSnippetCode" class="language-javascript">/* O snippet de código aparecerá aqui... */</code></pre>
                                <button id="copySnippetCodeBtn" class="absolute top-2 right-2 bg-zinc-700 hover:bg-zinc-600 text-gray-300 p-2 rounded-lg" title="Copiar Código">
                                    <i data-lucide="copy" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- README View -->
            <div id="readme-view" class="view hidden bg-zinc-900 border border-zinc-800 p-8 rounded-xl shadow-sm prose prose-invert max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-orange-500">Como Usar o Gerador de Funções</h2>
                <p class="mt-4 text-gray-400">Este guia explica como usar o código gerado por este aplicativo para implementar o tracking de eventos de forma padronizada.</p>
                
                <div class="mt-8 space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold">1. A Função `trackEvent` Genérica</h3>
                        <p class="mt-2 text-gray-400">A base de tudo é uma função genérica `trackEvent`. Você deve ter uma função similar no seu projeto. Ela é responsável por se comunicar com o RudderStack.</p>
                        <pre class="mt-2 text-sm"><code class="language-javascript">async function trackEvent(eventName, properties) {
  if (window.rudderanalytics && typeof window.rudderanalytics.track === "function") {
    window.rudderanalytics.track(eventName, properties || {});
    console.log(`Event tracked: ${eventName}`, properties);
  } else {
    console.warn(`RudderStack not found. Event "${eventName}" not tracked.`);
  }
}</code></pre>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold">2. Usando o Gerador de Snippet</h3>
                        <p class="mt-2 text-gray-400">Vá para a aba "Gerador de Snippet". Você pode preencher os campos manualmente ou usar o novo fluxo otimizado:</p>
                        <ol class="list-decimal list-inside mt-2 space-y-2 text-gray-400">
                            <li>Vá para a aba <b>Kanban</b> e encontre o card do evento que deseja implementar.</li>
                            <li>Clique no ícone de código (<i data-lucide="code" class="inline-block w-4 h-4"></i>) para abrir o "Gerador de Código".</li>
                            <li>Copie o código gerado.</li>
                            <li>Volte para a aba <b>Gerador de Snippet</b> e clique no botão <b>"Importar do Card"</b>.</li>
                            <li>Cole o código na janela que aparecer e clique em "Analisar". Os campos serão preenchidos automaticamente.</li>
                            <li>Ajuste o ID do elemento e os nomes dos atributos `data-*` conforme necessário e clique em "Gerar Snippet".</li>
                        </ol>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold">3. Exemplo de Snippet Gerado</h3>
                        <p class="mt-2 text-gray-400">Para um evento "Product Viewed", o código gerado será parecido com este:</p>
                        <pre class="mt-2 text-sm"><code class="language-javascript">/**
 * Função para capturar dados do PDP e disparar evento de tracking.
 * Só dispara o evento uma vez por carregamento de página.
 */
window.productViewedEventFired = window.productViewedEventFired || false;

function trackProductViewed() {
    if (window.productViewedEventFired) {
        return;
    }

    const trackingDiv = document.getElementById('pdp-tracking-data');
    if (!trackingDiv) {
        console.warn('Elemento de tracking "pdp-tracking-data" não encontrado.');
        return;
    }

    const eventProperties = {
        productId: trackingDiv.dataset.productId,
        sku: trackingDiv.dataset.sku,
        price: parseFloat(trackingDiv.dataset.price) || 0,
        available: trackingDiv.dataset.available === 'true',
    };

    if (typeof trackEvent === 'function') {
        trackEvent('Product Viewed', eventProperties);
        window.productViewedEventFired = true;
    } else {
        console.warn('Função global trackEvent não encontrada.');
    }
}

// Dispara o evento após o carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(trackProductViewed, 500);
});

// Expõe a função globalmente se necessário
window.trackProductViewed = trackProductViewed;
</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal (for Kanban) -->
    <div id="eventModal" class="modal-backdrop">
        <div class="modal-content">
            <div id="parser-view" class="hidden space-y-4">
                 <h3 class="text-lg font-semibold">Preencher com Código</h3>
                 <p class="text-sm text-gray-400">Cole seu código `rudderanalytics.track(...)` abaixo para preencher o formulário automaticamente.</p>
                 <textarea id="codeInput" class="w-full h-40 p-2 border rounded-md font-mono text-sm bg-gray-800 border-gray-600" placeholder='rudderanalytics.track("Event Name", { key: "value" });'></textarea>
                 <div class="flex justify-end gap-2">
                     <button type="button" id="backToFormBtn" class="bg-gray-600 text-gray-200 font-semibold px-4 py-2 rounded-lg hover:bg-gray-500">Voltar</button>
                     <button type="button" id="parseCodeBtn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-600">Analisar</button>
                 </div>
            </div>
            <form id="eventForm">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold">Adicionar Novo Evento</h2>
                    <button type="button" id="openParserBtn" title="Preencher com Código" class="text-orange-500 hover:text-orange-600 flex items-center gap-2 font-semibold">
                        <i data-lucide="wand-2" class="w-5 h-5"></i>
                        <span>Preencher com Código</span>
                    </button>
                </div>
                <input type="hidden" id="eventId">
                <div class="space-y-4">
                    <input type="text" id="eventNameInput" placeholder="Nome do Evento" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700" required>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="text" id="eventOwnerInput" placeholder="Responsável" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700">
                        <input type="text" id="eventSectionInput" placeholder="Seção do Site" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <select id="eventPrioritySelect" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700">
                            <option value="Baixa">Prioridade: Baixa</option>
                            <option value="Média">Prioridade: Média</option>
                            <option value="Alta">Prioridade: Alta</option>
                        </select>
                        <select id="eventTypeSelect" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700">
                            <option value="Página">Tipo: Página</option>
                            <option value="Componente">Tipo: Componente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Dados do Evento (Payload)</label>
                        <div class="max-h-48 overflow-y-auto p-2 border rounded-lg bg-gray-800 border-zinc-700">
                            <div id="payload-list" class="space-y-2"></div>
                        </div>
                        <button type="button" id="addPayloadBtn" class="mt-2 text-sm text-orange-500 font-semibold hover:text-orange-600 flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>Adicionar Propriedade
                        </button>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancelBtn" class="bg-gray-600 text-gray-200 font-semibold px-6 py-2 rounded-lg hover:bg-gray-500">Cancelar</button>
                    <button type="submit" id="saveBtn" class="bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-600">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-backdrop">
        <div class="modal-content text-center">
             <i data-lucide="alert-triangle" class="mx-auto w-12 h-12 text-red-500"></i>
             <h2 class="text-xl font-bold mb-2">Confirmar Exclusão</h2>
             <p id="deleteModalText" class="text-gray-400 mb-6">Você tem certeza?</p>
             <div class="flex justify-center gap-4">
                 <button id="cancelDeleteBtn" class="bg-gray-600 text-gray-200 font-semibold px-6 py-2 rounded-lg hover:bg-gray-500">Cancelar</button>
                 <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-700">Excluir</button>
             </div>
        </div>
    </div>

    <!-- Name Prompt Modal -->
    <div id="namePromptModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Qual é o seu nome?</h2>
            <p class="text-gray-400 mb-6">Seu nome será exibido nos comentários que você adicionar.</p>
            <input type="text" id="commenterNameInput" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-700" placeholder="Seu nome">
            <div class="mt-6 flex justify-end">
                <button id="saveNameBtn" class="bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-600">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Code Generator Modal (for Kanban) -->
    <div id="codeGeneratorModal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[85vh]">
            <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Gerador de Código</h2>
            <p class="text-sm text-gray-400 mb-4 flex-shrink-0">Copie e cole este código em seu projeto para disparar o evento.</p>
            
            <div class="flex-grow overflow-auto rounded-lg">
                 <pre class="text-sm"><code id="generatedCode" class="language-javascript"></code></pre>
            </div>

            <div class="mt-6 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="closeCodeModalBtn" class="bg-gray-600 text-gray-200 font-semibold px-6 py-2 rounded-lg hover:bg-gray-500">Fechar</button>
                <button type="button" id="copyCodeBtn" class="bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-600">Copiar Código</button>
            </div>
        </div>
    </div>
    
    <!-- Import from Card Modal -->
    <div id="importFromCardModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Importar do Card</h2>
            <p class="text-sm text-gray-400 mb-4">Cole o código gerado no Kanban para preencher os campos automaticamente.</p>
            <textarea id="importCodeInput" class="w-full h-48 p-2 border rounded-md font-mono text-sm bg-zinc-800 border-zinc-700" placeholder="Cole o código aqui..."></textarea>
            <div class="mt-6 flex justify-end gap-4">
                <button type="button" id="cancelImportBtn" class="bg-gray-600 text-gray-200 font-semibold px-6 py-2 rounded-lg hover:bg-gray-500">Cancelar</button>
                <button type="button" id="processImportBtn" class="bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-600">Analisar</button>
            </div>
        </div>
    </div>


    <div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, setLogLevel, getDocs, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2M2M_RIuMint7AGq2g8P6WhME3r3tmXA",
            authDomain: "rudderstack-tracker.firebaseapp.com",
            projectId: "rudderstack-tracker",
            storageBucket: "rudderstack-tracker.appspot.com",
            messagingSenderId: "266981975854",
            appId: "1:266981975854:web:ee97744517411bca1afcbf",
            measurementId: "G-0KKD05HRLB"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        // --- DOM Elements ---
        const appIdDisplay = document.getElementById('appIdDisplay');
        const todoList = document.getElementById('todo-list');
        const inprogressList = document.getElementById('inprogress-list');
        const doneList = document.getElementById('done-list');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const searchInput = document.getElementById('searchInput');
        const filterOwner = document.getElementById('filterOwner');
        const filterSection = document.getElementById('filterSection');
        const sortSelect = document.getElementById('sortSelect');
        const openAddModalBtn = document.getElementById('openAddModalBtn');
        const eventModal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalTitle');
        const eventForm = document.getElementById('eventForm');
        const eventIdInput = document.getElementById('eventId');
        const eventNameInput = document.getElementById('eventNameInput');
        const eventOwnerInput = document.getElementById('eventOwnerInput');
        const eventSectionInput = document.getElementById('eventSectionInput');
        const eventTypeSelect = document.getElementById('eventTypeSelect');
        const payloadList = document.getElementById('payload-list');
        const addPayloadBtn = document.getElementById('addPayloadBtn');
        const eventPrioritySelect = document.getElementById('eventPrioritySelect');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteModalText = document.getElementById('deleteModalText');
        const toast = document.getElementById('toast-notification');
        // Parser elements
        const parserView = document.getElementById('parser-view');
        const openParserBtn = document.getElementById('openParserBtn');
        const backToFormBtn = document.getElementById('backToFormBtn');
        const parseCodeBtn = document.getElementById('parseCodeBtn');
        const codeInput = document.getElementById('codeInput');
        // Name Prompt Modal
        const namePromptModal = document.getElementById('namePromptModal');
        const commenterNameInput = document.getElementById('commenterNameInput');
        const saveNameBtn = document.getElementById('saveNameBtn');
        // View Toggle
        const kanbanViewBtn = document.getElementById('kanbanViewBtn');
        const mapViewBtn = document.getElementById('mapViewBtn');
        const readmeViewBtn = document.getElementById('readmeViewBtn');
        const kanbanView = document.getElementById('kanban-view');
        const eventMapView = document.getElementById('map-view'); // FIX: Corrected ID
        const readmeView = document.getElementById('readme-view');
        const kanbanControls = document.getElementById('kanban-controls');
        const controlsToolbar = document.getElementById('controls-toolbar');
        // Code Generator Modal
        const codeGeneratorModal = document.getElementById('codeGeneratorModal');
        const generatedCode = document.getElementById('generatedCode');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const closeCodeModalBtn = document.getElementById('closeCodeModalBtn');
        // Snippet Generator Elements
        const snippetGeneratorViewBtn = document.getElementById('snippetGeneratorViewBtn');
        const snippetGeneratorView = document.getElementById('snippet-generator-view');
        const snippetEventName = document.getElementById('snippetEventName');
        const snippetElementId = document.getElementById('snippetElementId');
        const snippetPropertiesList = document.getElementById('snippet-properties-list');
        const addSnippetPropertyBtn = document.getElementById('addSnippetPropertyBtn');
        const generateSnippetBtn = document.getElementById('generateSnippetBtn');
        const generatedSnippetCode = document.getElementById('generatedSnippetCode');
        const copySnippetCodeBtn = document.getElementById('copySnippetCodeBtn');
        // Import from Card Elements
        const importFromCardBtn = document.getElementById('importFromCardBtn');
        const importFromCardModal = document.getElementById('importFromCardModal');
        const importCodeInput = document.getElementById('importCodeInput');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const processImportBtn = document.getElementById('processImportBtn');


        // --- App State ---
        let currentAppId = null;
        let userId = null;
        let eventsCollectionRef;
        let allEvents = [];
        let unsubscribe;

        // --- App Initialization ---
        const handleAppLoad = () => {
            const urlParams = new URLSearchParams(window.location.search);
            let sheetId = urlParams.get('sheetId');

            if (!sheetId) {
                sheetId = `rudder-sheet-default`; // Use a default ID if none is provided
            }
            
            initializeAppForId(sheetId);
        };

        const initializeAppForId = (appId) => {
            currentAppId = appId;
            if (appIdDisplay) { // Check if element exists before using it
                appIdDisplay.textContent = currentAppId;
            }

            signInAnonymously(auth)
                .then((userCredential) => {
                    userId = userCredential.user.uid;
                    eventsCollectionRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'events');
                    if (unsubscribe) unsubscribe();
                    listenForEvents();
                })
                .catch((error) => {
                    console.error("Authentication Error:", error);
                    if (appIdDisplay) {
                        appIdDisplay.textContent = "Erro de autenticação";
                    }
                });
        };
        
        // --- Data Fetching & Rendering ---
        const listenForEvents = () => {
            if (!eventsCollectionRef) return;
            unsubscribe = onSnapshot(eventsCollectionRef, (snapshot) => {
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEvents();
                renderEventMap();
            });
        };

        const renderEvents = () => {
            updateDynamicFilters();
            todoList.innerHTML = '';
            inprogressList.innerHTML = '';
            doneList.innerHTML = '';
            let filteredEvents = allEvents.filter(event => {
                const searchMatch = event.name.toLowerCase().includes(searchInput.value.toLowerCase());
                const ownerMatch = filterOwner.value === 'all' || event.owner === filterOwner.value;
                const sectionMatch = filterSection.value === 'all' || event.section === filterSection.value;
                return searchMatch && ownerMatch && sectionMatch;
            });
            
            const priorityOrder = { 'Alta': 3, 'Média': 2, 'Baixa': 1 };
            if (sortSelect.value === 'priority') {
                filteredEvents.sort((a, b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0));
            } else { // createdAt (default)
                filteredEvents.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            }
            
            if (filteredEvents.length === 0 && allEvents.length > 0) {
                 const emptyMessage = `<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nenhum evento corresponde aos filtros atuais.</p>`;
                 todoList.innerHTML = emptyMessage;
                 inprogressList.innerHTML = emptyMessage;
                 doneList.innerHTML = emptyMessage;
            } else if (allEvents.length === 0) {
                 todoList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nenhum evento a fazer. Adicione um!</p>`;
                 inprogressList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nenhum evento em progresso.</p>`;
                 doneList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nenhum evento concluído.</p>`;
            }

            filteredEvents.forEach(event => {
                const eventCard = createEventCard(event);
                if (event.status === 'inprogress') {
                    inprogressList.appendChild(eventCard);
                } else if (event.status === 'done') {
                    doneList.appendChild(eventCard);
                } else { // 'todo' or undefined
                    todoList.appendChild(eventCard);
                }
            });
            updateProgress(allEvents.length, allEvents.filter(e => e.status === 'done').length);
            lucide.createIcons();
        };

        const renderEventMap = () => {
            eventMapView.innerHTML = '';
            const eventsBySection = allEvents.reduce((acc, event) => {
                const section = event.section || 'Não Categorizado';
                if (!acc[section]) {
                    acc[section] = { events: [], owners: new Set() };
                }
                acc[section].events.push(event);
                if (event.owner && event.owner !== 'Não atribuído') {
                    acc[section].owners.add(event.owner);
                }
                return acc;
            }, {});

            if (Object.keys(eventsBySection).length === 0) {
                eventMapView.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nenhum evento para exibir no mapa. Adicione um evento com uma seção.</p>`;
                return;
            }

            for (const section in eventsBySection) {
                const sectionData = eventsBySection[section];
                const sectionEvents = sectionData.events;
                const owners = Array.from(sectionData.owners).join(', ');

                const todoCount = sectionEvents.filter(e => e.status === 'todo' || !e.status).length;
                const inprogressCount = sectionEvents.filter(e => e.status === 'inprogress').length;
                const doneCount = sectionEvents.filter(e => e.status === 'done').length;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'border-b dark:border-gray-700 pb-4';
                sectionDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">${section}</h3>
                        ${owners ? `<span class="text-sm font-semibold text-gray-500 dark:text-gray-400">${owners}</span>` : ''}
                    </div>
                    <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                        <span>Total: <span class="font-semibold">${sectionEvents.length}</span></span>
                        <span class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-red-500"></div>A Fazer: <span class="font-semibold">${todoCount}</span></span>
                        <span class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-yellow-500"></div>Em Progresso: <span class="font-semibold">${inprogressCount}</span></span>
                        <span class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-green-500"></div>Feito: <span class="font-semibold">${doneCount}</span></span>
                    </div>
                    <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        ${sectionEvents.map(event => {
                            const statusColors = { todo: 'bg-red-500', inprogress: 'bg-yellow-500', done: 'bg-green-500' };
                            const statusColor = statusColors[event.status] || 'bg-red-500';
                            return `<li class="map-event-item cursor-pointer hover:bg-gray-200 dark:hover:bg-zinc-800 flex items-center gap-2 p-2 bg-gray-100 dark:bg-zinc-900/50 rounded-md" data-event-id="${event.id}">
                                <div class="w-2 h-2 rounded-full ${statusColor} flex-shrink-0"></div>
                                <span class="text-sm text-gray-800 dark:text-gray-300">${event.name}</span>
                            </li>`;
                        }).join('')}
                    </ul>
                `;
                eventMapView.appendChild(sectionDiv);
            }
        };

        const createEventCard = (event) => {
            const card = document.createElement('div');
            card.className = 'card relative bg-zinc-800 p-4 rounded-lg shadow-sm space-y-3 border-l-4'; // Changed base color
            card.dataset.eventId = event.id;
            
            const priorityStyles = {
                'Alta':  { badge: 'bg-red-900/50 text-red-300', border: 'border-l-red-500' },
                'Média': { badge: 'bg-yellow-900/50 text-yellow-300', border: 'border-l-yellow-500' },
                'Baixa': { badge: 'bg-gray-700 text-gray-300', border: 'border-l-gray-400' }
            };
            const style = priorityStyles[event.priority] || priorityStyles['Baixa'];
            card.classList.add(style.border);
            
            let actionButtons = '';
            switch(event.status) {
                case 'inprogress':
                    actionButtons = `
                        <button title="Mover para A Fazer" class="action-btn text-gray-400 hover:text-red-500" data-action="todo"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                        <button title="Concluir" class="action-btn text-gray-400 hover:text-green-500" data-action="done"><i data-lucide="check-circle-2" class="w-5 h-5"></i></button>
                    `;
                    break;
                case 'done':
                    actionButtons = `<button title="Mover para Em Progresso" class="action-btn text-gray-400 hover:text-yellow-500" data-action="inprogress"><i data-lucide="loader-2" class="w-5 h-5"></i></button>`;
                    break;
                case 'todo':
                default:
                    actionButtons = `<button title="Iniciar Progresso" class="action-btn text-gray-400 hover:text-yellow-500" data-action="inprogress"><i data-lucide="arrow-right-circle" class="w-5 h-5"></i></button>`;
                    break;
            }
            
            const payloadHtml = Array.isArray(event.payload) && event.payload.length > 0
                ? `<details class="pt-2">
                    <summary class="cursor-pointer text-sm font-semibold text-gray-300 hover:text-orange-400 flex items-center gap-1">
                        <i data-lucide="database" class="w-4 h-4"></i> Dados do Evento
                    </summary>
                    <div class="mt-2 p-2 bg-zinc-900 rounded-md text-xs text-gray-300">
                        <ul class="space-y-1">
                            ${event.payload.map(p => `<li><span class="font-semibold">${p.name || 'N/A'}:</span> <span class="text-gray-400">${p.type || 'N/A'}</span></li>`).join('')}
                        </ul>
                    </div>
                </details>`
                : '';

            const commentsCount = Array.isArray(event.comments) ? event.comments.length : 0;
            const commentsHtml = `
                <details class="pt-2">
                    <summary class="cursor-pointer text-sm font-semibold text-gray-300 hover:text-orange-400 flex items-center gap-1">
                        <i data-lucide="message-square" class="w-4 h-4"></i> Comentários (${commentsCount})
                    </summary>
                    <div class="mt-2 p-2 bg-zinc-900 rounded-md text-xs text-gray-300">
                        <div class="comment-list space-y-2 max-h-40 overflow-y-auto mb-2">
                            ${commentsCount > 0 ? event.comments.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).map((c, index) => {
                                const commentDate = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                                const formattedDate = !isNaN(commentDate) ? commentDate.toLocaleString('pt-BR') : 'Data inválida';
                                return `
                                <div class="comment-item p-2 bg-zinc-800 rounded">
                                    <div class="flex justify-between items-start">
                                        <p class="font-semibold">${c.author || 'Anônimo'}</p>
                                        <div class="flex gap-2">
                                            <button class="edit-comment-btn text-gray-400 hover:text-orange-500" data-index="${index}"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                                            <button class="delete-comment-btn text-gray-400 hover:text-red-600" data-index="${index}"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                    <p class="comment-text text-gray-400">${c.text}</p>
                                    <p class="text-gray-500 text-right text-[10px]">${formattedDate}</p>
                                </div>
                            `}).join('') : '<p class="text-center text-gray-500 p-2">Nenhum comentário ainda.</p>'}
                        </div>
                        <div class="flex gap-2 items-center pt-2 border-t border-zinc-700">
                            <input type="text" class="new-comment-input w-full px-2 py-1 border border-zinc-700 rounded-md text-xs bg-zinc-700" placeholder="Adicionar comentário...">
                            <button class="add-comment-btn bg-orange-500 text-white rounded-md p-1 hover:bg-orange-600"><i data-lucide="send" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </details>
            `;

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-bold text-lg text-gray-100 pr-2">${event.name}</p>
                    <div class="flex items-center gap-2">
                        ${event.type ? `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${event.type === 'Página' ? 'bg-indigo-900/50 text-indigo-300' : 'bg-pink-900/50 text-pink-300'}">${event.type}</span>` : ''}
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${style.badge} flex-shrink-0">${event.priority}</span>
                    </div>
                </div>
                <div class="text-sm text-gray-400 space-y-1.5">
                    <p><i data-lucide="user-circle" class="inline-block w-4 h-4 mr-2 text-gray-500"></i><span class="font-medium">${event.owner || 'N/A'}</span></p>
                    <p><i data-lucide="layout-template" class="inline-block w-4 h-4 mr-2 text-gray-500"></i><span class="font-medium">${event.section || 'N/A'}</span></p>
                </div>
                ${payloadHtml}
                ${commentsHtml}
                <div class="flex items-center justify-end gap-3 pt-2 border-t border-zinc-700 mt-3">
                    <button title="Gerar Código" class="generate-code-btn text-gray-400 hover:text-green-500 transition-colors"><i data-lucide="code" class="w-5 h-5"></i></button>
                    <button title="Editar" class="edit-btn text-gray-400 hover:text-orange-500 transition-colors"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                    ${actionButtons}
                    <button title="Excluir" class="delete-btn text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>`;
            
            card.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', () => updateEventStatus(event.id, btn.dataset.action)));
            card.querySelector('.delete-btn').addEventListener('click', () => openDeleteModal(event));
            card.querySelector('.edit-btn').addEventListener('click', () => openEditModal(event));
            card.querySelector('.generate-code-btn').addEventListener('click', () => openCodeGeneratorModal(event));
            card.querySelector('.add-comment-btn').addEventListener('click', (e) => {
                const input = e.currentTarget.previousElementSibling;
                addComment(event.id, input.value);
                input.value = '';
            });
            card.querySelectorAll('.edit-comment-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditComment(e, event.id)));
            card.querySelectorAll('.delete-comment-btn').forEach(btn => btn.addEventListener('click', (e) => deleteComment(event.id, e.currentTarget.dataset.index)));

            return card;
        };

        // --- Actions & UI Helpers ---
        const updateEventStatus = async (id, newStatus) => {
            const author = sessionStorage.getItem('commenterName') || 'Usuário';
            const statusMap = {
                todo: 'A Fazer',
                inprogress: 'Em Progresso',
                done: 'Feito'
            };
            const comment = {
                author: 'Sistema',
                text: `${author} moveu o evento para "${statusMap[newStatus]}".`,
                createdAt: new Date()
            };
            await updateDoc(doc(db, eventsCollectionRef.path, id), { 
                status: newStatus,
                comments: arrayUnion(comment)
            });
        };
        
        const addComment = async (eventId, text) => {
            if (!text.trim()) return;

            let author = sessionStorage.getItem('commenterName');
            if (!author) {
                namePromptModal.classList.add('visible');
                
                const namePromise = new Promise(resolve => {
                    saveNameBtn.onclick = () => {
                        const newName = commenterNameInput.value.trim();
                        if (newName) {
                            sessionStorage.setItem('commenterName', newName);
                            namePromptModal.classList.remove('visible');
                            resolve(newName);
                        }
                    };
                });
                author = await namePromise;
            }

            const comment = {
                author,
                text,
                createdAt: new Date()
            };
            
            const eventDocRef = doc(db, eventsCollectionRef.path, eventId);
            await updateDoc(eventDocRef, {
                comments: arrayUnion(comment)
            });
        };

        const handleEditComment = (e, eventId) => {
            const commentItem = e.currentTarget.closest('.comment-item');
            const commentTextP = commentItem.querySelector('.comment-text');
            const originalText = commentTextP.textContent;
            
            const editInput = document.createElement('input');
            editInput.type = 'text';
            editInput.value = originalText;
            editInput.className = 'w-full px-2 py-1 border border-orange-300 rounded-md text-xs bg-gray-700';

            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
            saveBtn.className = 'text-green-600';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
            cancelBtn.className = 'text-red-600';

            const editContainer = document.createElement('div');
            editContainer.className = 'flex items-center gap-2 mt-1';
            editContainer.append(editInput, saveBtn, cancelBtn);
            
            commentTextP.replaceWith(editContainer);
            lucide.createIcons();

            cancelBtn.onclick = () => editContainer.replaceWith(commentTextP);
            saveBtn.onclick = () => {
                updateComment(eventId, e.currentTarget.dataset.index, editInput.value);
            };
        };

        const updateComment = async (eventId, indexToUpdate, newText) => {
            const eventToUpdate = allEvents.find(e => e.id === eventId);
            if (!eventToUpdate) return;

            const sortedComments = (eventToUpdate.comments || []).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            if (sortedComments[indexToUpdate]) {
                sortedComments[indexToUpdate].text = newText;
            }

            const eventDocRef = doc(db, eventsCollectionRef.path, eventId);
            await updateDoc(eventDocRef, { comments: sortedComments });
        };

        const deleteComment = async (eventId, indexToDelete) => {
            const eventToUpdate = allEvents.find(e => e.id === eventId);
            if (!eventToUpdate) return;
            
            const sortedComments = (eventToUpdate.comments || []).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
            sortedComments.splice(indexToDelete, 1);

            const eventDocRef = doc(db, eventsCollectionRef.path, eventId);
            await updateDoc(eventDocRef, { comments: sortedComments });
        };

        const saveEvent = async (e) => {
            e.preventDefault();
            const id = eventIdInput.value;
            
            const payloadData = [];
            document.querySelectorAll('.payload-row').forEach(row => {
                const name = row.querySelector('.payload-name').value.trim();
                const type = row.querySelector('.payload-type').value;
                if (name) {
                    payloadData.push({ name, type });
                }
            });

            let data = { 
                name: eventNameInput.value.trim(), 
                owner: eventOwnerInput.value.trim() || 'Não atribuído', 
                section: eventSectionInput.value.trim() || 'N/A', 
                type: eventTypeSelect.value,
                priority: eventPrioritySelect.value,
                payload: payloadData
            };
            try {
                if (id) { 
                    await updateDoc(doc(db, eventsCollectionRef.path, id), data); 
                } else { 
                    data.status = 'todo'; 
                    data.createdAt = new Date();
                    data.comments = [];
                    await addDoc(eventsCollectionRef, data); 
                }
                closeEventModal();
            } catch (error) { console.error("Error saving event:", error); }
        };
        const updateProgress = (totalCount, doneCount) => {
            const percentage = totalCount === 0 ? 0 : (doneCount / totalCount) * 100;
            progressBar.style.width = `${percentage}%`;
            progressLabel.textContent = `Feito ${doneCount} de ${totalCount}`;
        };
        const updateDynamicFilters = () => {
            const owners = [...new Set(allEvents.map(e => e.owner).filter(Boolean))];
            const sections = [...new Set(allEvents.map(e => e.section).filter(Boolean))];
            const populateSelect = (selectEl, items) => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = '<option value="all">Todos</option>';
                items.sort().forEach(item => { selectEl.innerHTML += `<option value="${item}">${item}</option>`; });
                selectEl.value = items.includes(currentValue) ? currentValue : 'all';
            };
            populateSelect(filterOwner, owners);
            populateSelect(filterSection, sections);
        };
        const showToast = (message) => {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };

        // --- Modal Handling & Parser ---
        const addPayloadRow = (name = '', type = 'string') => {
            const row = document.createElement('div');
            row.className = 'payload-row flex items-center gap-2';
            row.innerHTML = `
                <input type="text" class="payload-name w-full px-3 py-1 border border-gray-600 rounded-md bg-gray-700" placeholder="Nome da Propriedade" value="${name}">
                <select class="payload-type form-select w-full px-3 py-1 border border-gray-600 rounded-md bg-gray-700">
                    <option value="string" ${type === 'string' ? 'selected' : ''}>String</option>
                    <option value="number" ${type === 'number' ? 'selected' : ''}>Number</option>
                    <option value="boolean" ${type === 'boolean' ? 'selected' : ''}>Boolean</option>
                    <option value="array" ${type === 'array' ? 'selected' : ''}>Array</option>
                </select>
                <button type="button" class="remove-payload-btn text-red-500 hover:text-red-700 flex-shrink-0"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
            `;
            row.querySelector('.remove-payload-btn').addEventListener('click', () => row.remove());
            payloadList.appendChild(row);
            lucide.createIcons();
        };
        
        const parseAndFillForm = () => {
            const code = codeInput.value;
            if (!code.includes('rudderanalytics.track')) {
                showToast("Código inválido. Cole o snippet do evento.");
                return;
            }

            try {
                const eventNameMatch = code.match(/rudderanalytics\.track\s*\(\s*["']([^"']+)["']/);
                const eventName = eventNameMatch ? eventNameMatch[1] : '';
                
                const objectMatch = code.match(/,\s*(\{[\s\S]*?\})\s*\)/);
                if (!objectMatch) throw new Error("Objeto de propriedades não encontrado.");

                let objectStr = objectMatch[1];
                objectStr = objectStr.replace(/(\w+)\s*:/g, '"$1":').replace(/'/g, '"').replace(/,\s*([}\]])/g, '$1');

                const properties = JSON.parse(objectStr);

                eventNameInput.value = eventName;
                payloadList.innerHTML = ''; 
                
                for (const key in properties) {
                    const value = properties[key];
                    let type = typeof value;
                    if (Array.isArray(value)) type = 'array';
                    else if (type === 'object' && value !== null) type = 'object'; 
                    addPayloadRow(key, type);
                }
                
                showToast("Formulário preenchido com sucesso!");
                parserView.classList.add('hidden');
                eventForm.classList.remove('hidden');

            } catch (error) {
                console.error("Erro de parse:", error);
                showToast("Erro ao analisar o código. Verifique o formato.");
            }
        };

        addPayloadBtn.addEventListener('click', () => addPayloadRow());

        const openEventModal = () => eventModal.classList.add('visible');
        const closeEventModal = () => {
            eventModal.classList.remove('visible');
            parserView.classList.add('hidden');
            eventForm.classList.remove('hidden');
        }
        const openAddModal = () => { 
            eventForm.reset(); 
            payloadList.innerHTML = '';
            addPayloadRow();
            eventIdInput.value = ''; 
            modalTitle.textContent = 'Adicionar Novo Evento'; 
            openEventModal(); 
        };
        const openEditModal = (event) => { 
            eventForm.reset(); 
            payloadList.innerHTML = '';
            if (Array.isArray(event.payload) && event.payload.length > 0) {
                event.payload.forEach(p => addPayloadRow(p.name, p.type));
            } else {
                addPayloadRow();
            }
            modalTitle.textContent = 'Editar Evento'; 
            eventIdInput.value = event.id; 
            eventNameInput.value = event.name; 
            eventOwnerInput.value = event.owner; 
            eventSectionInput.value = event.section; 
            eventTypeSelect.value = event.type || 'Página';
            eventPrioritySelect.value = event.priority; 
            openEventModal(); 
        };
        const openDeleteModal = (event) => {
            deleteModalText.textContent = `Tem certeza que deseja excluir o evento "${event.name}"? Esta ação não pode ser desfeita.`;
            confirmDeleteBtn.onclick = async () => { await deleteDoc(doc(db, eventsCollectionRef.path, event.id)); closeDeleteModal(); };
            deleteModal.classList.add('visible');
        };
        const closeDeleteModal = () => deleteModal.classList.remove('visible');

        const openCodeGeneratorModal = (event) => {
            const camelCaseName = event.name.replace(/\s(.)/g, (match, group1) => group1.toUpperCase()).replace(/\s/g, '');
            const propertiesMap = (event.payload || []).map(p => `      ${p.name}: rawData.${p.name} || null, // ${p.type}`).join('\n');
            const code = `
/**
 * Mapeia os dados brutos para as propriedades do evento "${event.name}".
 * @param {object} rawData - O objeto de dados original (ex: vindo de uma API).
 * @returns {object} - Um objeto com as propriedades formatadas.
 */
function get${camelCaseName}Properties(rawData) {
  return {
${propertiesMap}
  };
}

/**
 * Dispara o evento "${event.name}".
 * @param {object} rawData - O objeto de dados original para ser mapeado.
 */
function track${camelCaseName}(rawData) {
  trackEvent({
    id: "${camelCaseName}",
    eventName: "${event.name}",
    properties: get${camelCaseName}Properties(rawData),
  });
}

// Exemplo de como usar:
// const eventData = { /* ...seus dados aqui... */ };
// track${camelCaseName}(eventData);
`;
            generatedCode.textContent = code.trim();
            codeGeneratorModal.classList.add('visible');
        };

        // --- Event Listeners ---
        searchInput.addEventListener('input', renderEvents);
        filterOwner.addEventListener('input', renderEvents);
        filterSection.addEventListener('input', renderEvents);
        sortSelect.addEventListener('input', renderEvents);
        
        openAddModalBtn.addEventListener('click', openAddModal);
        cancelBtn.addEventListener('click', closeEventModal);
        eventForm.addEventListener('submit', saveEvent);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        
        // Parser listeners
        openParserBtn.addEventListener('click', () => {
            eventForm.classList.add('hidden');
            parserView.classList.remove('hidden');
        });
        backToFormBtn.addEventListener('click', () => {
            parserView.classList.add('hidden');
            eventForm.classList.remove('hidden');
        });
        parseCodeBtn.addEventListener('click', parseAndFillForm);

        // View toggle listeners
        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                views.forEach(view => {
                    if (view.id === `${targetId}-view`) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });
                
                if (targetId === 'snippet-generator' || targetId === 'readme') {
                    controlsToolbar.classList.add('hidden');
                } else {
                    controlsToolbar.classList.remove('hidden');
                }
            });
        });
        
        // Map View Click Listener
        eventMapView.addEventListener('click', (e) => {
            const targetLi = e.target.closest('.map-event-item');
            if (targetLi) {
                const eventId = targetLi.dataset.eventId;
                const eventToEdit = allEvents.find(event => event.id === eventId);
                if (eventToEdit) {
                    openEditModal(eventToEdit);
                }
            }
        });
        
        // Code Generator Listeners
        closeCodeModalBtn.addEventListener('click', () => codeGeneratorModal.classList.remove('visible'));
        copyCodeBtn.addEventListener('click', () => {
            copyToClipboard(generatedCode.textContent, 'Código copiado!');
        });

        // --- Snippet Generator Logic ---

        const addSnippetPropertyRow = (propName = '', dataAttr = '', propType = 'string') => {
            const row = document.createElement('div');
            row.className = 'snippet-property-row grid grid-cols-1 sm:grid-cols-3 gap-2 items-center';
            row.innerHTML = `
                <input type="text" class="prop-name w-full px-3 py-1 border border-zinc-600 rounded-md bg-zinc-700" placeholder="Nome da Propriedade" value="${propName}">
                <input type="text" class="data-attr w-full px-3 py-1 border border-zinc-600 rounded-md bg-zinc-700" placeholder="Nome do Atributo data-*" value="${dataAttr}">
                <div class="flex items-center gap-2">
                    <select class="prop-type form-select w-full px-3 py-1 border border-zinc-600 rounded-md bg-zinc-700">
                        <option value="string" ${propType === 'string' ? 'selected' : ''}>Texto</option>
                        <option value="float" ${propType === 'float' ? 'selected' : ''}>Número (Decimal)</option>
                        <option value="integer" ${propType === 'integer' ? 'selected' : ''}>Número (Inteiro)</option>
                        <option value="boolean" ${propType === 'boolean' ? 'selected' : ''}>Booleano (true/false)</option>
                    </select>
                    <button type="button" class="remove-prop-btn text-red-500 hover:text-red-700 flex-shrink-0"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                </div>
            `;
            row.querySelector('.remove-prop-btn').addEventListener('click', () => row.remove());
            snippetPropertiesList.appendChild(row);
            lucide.createIcons();
        };

        const generateSnippet = () => {
            const eventName = snippetEventName.value || 'My Event';
            const elementId = snippetElementId.value || 'tracking-element';
            const camelCaseEventName = eventName.replace(/\s(.)/g, (m, g) => g.toUpperCase()).replace(/\s/g, '');
            const functionName = `track${camelCaseEventName}`;
            const firedFlag = `${camelCaseEventName.charAt(0).toLowerCase() + camelCaseEventName.slice(1)}EventFired`;

            let propsString = '';
            const propRows = document.querySelectorAll('.snippet-property-row');
            propRows.forEach(row => {
                const propName = row.querySelector('.prop-name').value.trim();
                const dataAttr = row.querySelector('.data-attr').value.trim();
                const propType = row.querySelector('.prop-type').value;

                if (!propName || !dataAttr) return;
                
                const dataAccess = `trackingDiv.dataset.${dataAttr.replace(/^data-/, '')}`;
                let valueGetter = '';

                switch(propType) {
                    case 'float':
                        valueGetter = `parseFloat(${dataAccess}) || 0`;
                        break;
                    case 'integer':
                        valueGetter = `parseInt(${dataAccess}, 10) || 0`;
                        break;
                    case 'boolean':
                        valueGetter = `${dataAccess} === 'true'`;
                        break;
                    case 'string':
                    default:
                        valueGetter = `${dataAccess} || ''`;
                        break;
                }
                propsString += `        ${propName}: ${valueGetter},\n`;
            });

            const code = `
/**
 * Função para capturar dados e disparar o evento "${eventName}".
 * Só dispara o evento uma vez por carregamento de página.
 */
window.${firedFlag} = window.${firedFlag} || false;

function ${functionName}() {
    if (window.${firedFlag}) {
        return;
    }

    const trackingDiv = document.getElementById('${elementId}');
    if (!trackingDiv) {
        console.warn('Elemento de tracking "${elementId}" não encontrado.');
        return;
    }

    const eventProperties = {
${propsString.trim()}
    };

    if (typeof trackEvent === 'function') {
        trackEvent('${eventName}', eventProperties);
        window.${firedFlag} = true;
    } else {
        console.warn('Função global trackEvent não encontrada.');
    }
}

// Dispara o evento após o carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    // O timeout garante que todos os dados dinâmicos tenham sido carregados no DOM
    setTimeout(${functionName}, 500);
});

// Expõe a função globalmente se necessário
window.${functionName} = ${functionName};
`;
            generatedSnippetCode.textContent = code.trim();
        };

        addSnippetPropertyBtn.addEventListener('click', addSnippetPropertyRow);
        generateSnippetBtn.addEventListener('click', generateSnippet);
        copySnippetCodeBtn.addEventListener('click', () => {
            copyToClipboard(generatedSnippetCode.textContent, 'Snippet copiado!');
        });

        // --- Import from Card Logic ---
        importFromCardBtn.addEventListener('click', () => {
            importCodeInput.value = '';
            importFromCardModal.classList.add('visible');
        });
        cancelImportBtn.addEventListener('click', () => {
            importFromCardModal.classList.remove('visible');
        });
        processImportBtn.addEventListener('click', () => {
            const code = importCodeInput.value;
            try {
                // 1. Extract Event Name
                const eventNameMatch = code.match(/eventName:\s*"([^"]+)"/);
                if (!eventNameMatch) throw new Error("Nome do evento não encontrado.");
                snippetEventName.value = eventNameMatch[1];

                // 2. Extract properties
                const propertiesBlockMatch = code.match(/return\s*{([\s\S]*?)}/);
                if (!propertiesBlockMatch) throw new Error("Bloco de propriedades não encontrado.");
                
                const propertiesBlock = propertiesBlockMatch[1];
                const propLines = propertiesBlock.trim().split('\n');

                // Clear existing properties and add new ones
                snippetPropertiesList.innerHTML = '';

                propLines.forEach(line => {
                    const lineMatch = line.match(/(\w+):\s*rawData\.\w+\s*\|\|\s*\w+,?\s*\/\/\s*(\w+)/);
                    if (lineMatch) {
                        const propName = lineMatch[1];
                        const propTypeComment = lineMatch[2];
                        
                        const dataAttrName = propName.replace(/([A-Z])/g, "-$1").toLowerCase();
                        
                        let snippetType = 'string';
                        if (propTypeComment === 'number') snippetType = 'float';
                        if (propTypeComment === 'boolean') snippetType = 'boolean';
                        
                        addSnippetPropertyRow(propName, dataAttrName, snippetType);
                    }
                });
                
                showToast("Propriedades importadas com sucesso!");
                importFromCardModal.classList.remove('visible');

            } catch (error) {
                showToast(`Erro ao analisar o código: ${error.message}`);
                console.error(error);
            }
        });

        const copyToClipboard = (text, message) => {
             // FIX: Removed incorrect check that prevented copying code starting with a comment.
             if (!text || text.trim() === '') {
                showToast("Nada para copiar ainda.");
                return;
            }
            
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(message);
                } else {
                    showToast('Erro ao copiar código.');
                }
            } catch (err) {
                console.error('Não foi possível copiar', err);
                showToast('Erro ao copiar código.');
            }

            document.body.removeChild(textArea);
        };


        // --- Initial Load ---
        handleAppLoad();
        addSnippetPropertyRow(); // Start with one empty row
        lucide.createIcons();
    </script>
</body>
</html>
